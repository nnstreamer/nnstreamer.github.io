<!DOCTYPE html>
<html lang="en">
<head>

<base href="../..">

<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">


<title>Profiling tools</title>

<link rel="stylesheet" href="assets/css/custom_bootstrap.css" type="text/css">
<link rel="stylesheet" href="assets/css/bootstrap-toc.min.css" type="text/css">
<link rel="stylesheet" href="assets/css/frontend.css" type="text/css">
<link rel="stylesheet" href="assets/css/jquery.mCustomScrollbar.min.css">
<link rel="stylesheet" href="assets/js/search/enable_search.css" type="text/css">

<link rel="stylesheet" href="assets/css/extra_frontend.css" type="text/css">
<link rel="stylesheet" href="assets/css/prism-tomorrow.css" type="text/css">

<script src="assets/js/mustache.min.js"></script>
<script src="assets/js/jquery.js"></script>
<script src="assets/js/bootstrap.js"></script>
<script src="assets/js/scrollspy.js"></script>
<script src="assets/js/typeahead.jquery.min.js"></script>
<script src="assets/js/search.js"></script>
<script src="assets/js/compare-versions.js"></script>
<script src="assets/js/jquery.mCustomScrollbar.concat.min.js"></script>
<script src="assets/js/bootstrap-toc.min.js"></script>
<script src="assets/js/jquery.touchSwipe.min.js"></script>
<script src="assets/js/anchor.min.js"></script>
<script src="assets/js/tag_filtering.js"></script>
<script src="assets/js/language_switching.js"></script>

<script src="assets/js/lines_around_headings.js"></script>

<script src="assets/js/trie.js"></script>
<script src="assets/js/prism-core.js"></script>
<script src="assets/js/prism-autoloader.js"></script>
<script src="assets/js/prism_autoloader_path_override.js"></script>

<link rel="icon" type="image/png" href="assets/images/nnstreamer_logo.png">

</head>

<body class="no-script
">

<script>
$('body').removeClass('no-script');
</script>

<nav class="navbar navbar-fixed-top navbar-default" id="topnav">
	<div class="container-fluid">
		<div class="navbar-right">
			<a id="toc-toggle">
				<span class="glyphicon glyphicon-menu-right"></span>
				<span class="glyphicon glyphicon-menu-left"></span>
			</a>
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-wrapper" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<form class="navbar-form pull-right" id="navbar-search-form">
                               <div class="form-group has-feedback">
                                       <input type="text" class="form-control input-sm" name="search" id="sidenav-lookup-field" placeholder="search" disabled>
				       <span class="glyphicon glyphicon-search form-control-feedback" id="search-mgn-glass"></span>
                               </div>
                        </form>
		</div>
		<div class="navbar-header">
			<a id="sidenav-toggle">
				<span class="glyphicon glyphicon-menu-right"></span>
				<span class="glyphicon glyphicon-menu-left"></span>
			</a>
			<a id="home-link" href="index.html" class="hotdoc-navbar-brand">
				<img src="assets/images/nnstreamer_logo.png" alt="Home">
			</a>
		</div>
		<div class="navbar-collapse collapse" id="navbar-wrapper">
			<ul class="nav navbar-nav" id="menu">
				
<li class="dropdown">
    <a class="dropdown-toggle" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        API References<span class="caret"></span>
    </a>
	<ul class="dropdown-menu" id="modules-menu">
					<li>
				<a href="doc-index.html">NNStreamer doc</a>
			</li>
					<li>
				<a href="gst/nnstreamer/README.html">NNStreamer Elements</a>
			</li>
					<li>
				<a href="nnstreamer-example/index.html">NNStreamer Examples</a>
			</li>
					<li>
				<a href="API-reference.html">API reference</a>
			</li>
		</ul>
</li>

<li>
	<a href="doc-index.html">Documents</a>
</li>
<li>
	<a href="gst/nnstreamer/README.html">Elements</a>
</li>
<li>
	<a href="tutorials.html">Tutorials</a>
</li>
<li>
	<a href="API-reference.html">API reference</a>
</li>

			</ul>
			<div class="hidden-xs hidden-sm navbar-text navbar-center">
							</div>
		</div>
	</div>
</nav>

<main>
<div data-extension="core" data-hotdoc-in-toplevel="True" data-hotdoc-project="NNStreamer" data-hotdoc-ref="tools/profiling/README.html" class="page_container" id="page-wrapper">
<script src="assets/js/utils.js"></script>

<div class="panel panel-collapse oc-collapsed" id="sidenav" data-hotdoc-role="navigation">
	<script src="assets/js/navigation.js"></script>
	<script src="assets/js/sitemap.js"></script>
</div>

<div id="body">
	<div id="main">
				    <div id="page-description" data-hotdoc-role="main">
        <h2 id="profiling">Profiling</h2>
<h3 id="nnshark">NNShark</h3>
<p>Press <a href="https://github.com/nnstreamer/nnshark">here</a> for further information.</p>
<h3 id="gstinstruments">gst-instruments</h3>
<p>The <a href="https://github.com/kirushyk/gst-instruments">gst-instruments</a> tool is an easy-to-use profiler for GStreamer.
This guide is experimented on Ubuntu 16.04 x86_64 distribution.</p>
<ul>
<li>gst-top displays performance report in real time such as top and perf-top utility.</li>
<li>gst-report-1.0 generates the trace file the below two goals as following:
<ul>
<li>It display CPU usage, time usage, and execution time amon the elements. We can easily profile who spends CPU resource mostly.</li>
<li>It generate a performance graph from a GStreamer pipeline. The graph shows a transfer size as well as CPU usage, time usage, and execution time.</li>
</ul>
</li>
</ul>
<h4 id="prerequisite">Prerequisite</h4>
<pre><code class="language-bash">$ sudo apt install autoreconf pkg-config automake libtool
</code></pre>
<h4 id="how-to-build-source-code">How to build source code</h4>
<pre><code class="language-bash">$ git clone https://github.com/kirushyk/gst-instruments.git
$ cd gst-instruments
$ git checkout -v 0.2.3 0.2.3
$ vi ./autogen.sh
--------------- patch: start ----------------------------------
@@ -19,7 +19,7 @@ which "aclocal" 2&gt;/dev/null || {
 }

 echo "Checking for libtool..."
-which "libtool" 2&gt;/dev/null || {
+which "libtoolize" 2&gt;/dev/null || {
   echo "Please install libtool."
   exit 1
 }
--------------- patch: end   ----------------------------------
$ ./autodgen.sh
$ ./configure
$ make -j`nproc`
$ sudo make install 
$ ls /usr/local/lib/libgstintercept.* -al
-rw-r--r-- 1 root root 232492 Nov 21 11:49 /usr/local/lib/libgstintercept.a
-rwxr-xr-x 1 root root   1039 Nov 21 11:49 /usr/local/lib/libgstintercept.la
lrwxrwxrwx 1 root root     24 Nov 21 11:49 /usr/local/lib/libgstintercept.so -&gt; libgstintercept.so.0.0.0
lrwxrwxrwx 1 root root     24 Nov 21 11:49 /usr/local/lib/libgstintercept.so.0 -&gt; libgstintercept.so.0.0.0
-rwxr-xr-x 1 root root 121312 Nov 21 11:49 /usr/local/lib/libgstintercept.so.0.0.0
</code></pre>
<h4 id="gsttop">gst-top</h4>
<pre><code class="language-bash">$ gst-top-1.0 gst-launch-1.0 audiotestsrc num-buffers=1000 ! vorbisenc ! vorbisdec ! fakesink
Setting pipeline to PAUSED ...
Pipeline is PREROLLING ...
Redistribute latency...
Pipeline is PREROLLED ...
Setting pipeline to PLAYING ...
New clock: GstSystemClock
Got EOS from element "pipeline0".
Execution ended after 0:00:00.301137359
Setting pipeline to PAUSED ...
Setting pipeline to READY ...
Setting pipeline to NULL ...
Freeing pipeline ...
ELEMENT        %CPU   %TIME   TIME
vorbisenc0      60.1   86.9    204 ms
vorbisdec0       8.0   11.6   27.3 ms
fakesink0        1.0    1.5   3.48 ms
audiotestsrc0    0.0    0.0      0 ns
pipeline0        0.0    0.0      0 ns
</code></pre>
<h4 id="gstreport">gst-report</h4>
<h5 id="how-to-display-a-performanc-report-with-a-trace-file">How to display a performanc report with a trace file</h5>
<pre><code class="language-bash">$ LD_PRELOAD=/usr/local/lib/libgstintercept.so \
    GST_DEBUG_DUMP_TRACE_DIR=. \
    gst-launch-1.0 audiotestsrc num-buffers=1000 ! vorbisenc ! vorbisdec ! fakesink
$ ls -al *.gsttrace
$ gst-report-1.0  pipeline0.gsttrace
ELEMENT        %CPU   %TIME   TIME
vorbisenc0      59.8   86.6    200 ms
vorbisdec0       8.2   11.9   27.5 ms
fakesink0        1.1    1.5   3.58 ms
pipeline0        0.0    0.0      0 ns
audiotestsrc0    0.0    0.0      0 ns
</code></pre>
<h5 id="how-to-generate-an-instrumentation-graph">How to generate an instrumentation graph</h5>
<pre><code class="language-bash">$ gst-report-1.0  --dot pipeline0.gsttrace | dot -Tpng &gt; perf.png
$ eog ./perf.png 
</code></pre>
<p><img src="tools/profiling/gst-instruments-perf.png" border="0"></p>
<h4 id="case-study-unit-test-in-nnstreamer">Case study: Unit test in NNStreamer</h4>
<pre><code class="language-bash">nnstreamer/test$ ./testAll.sh 1
nnstreamer/test$ cd performance/profile/tensor_convertor
$ eog ${number_of_test_case}.svg
</code></pre>
<p>Then, you can see a time cost and a CPU usage in pipeline.</p>
<h3 id="hawktracer">HawkTracer</h3>
<p>HawkTracer is a highly portable, low-overhead, configurable profiling tool built in Amazon Video for getting performance metrics from low-end devices.
The library provides many different types of events (e.g. CPU usage event, duration tracepoint), but the list can easily be extended by the user.</p>
<ul>
<li>https://amzn.github.io/hawktracer/index.html (Doxygen book for HawkTracer)</li>
</ul>
<h4 id="features">Features</h4>
<ul>
<li>Low CPU/memory overhead</li>
<li>Multi-platform</li>
<li>Highly configurable on runtime</li>
<li>Easy build integration (CMake &amp; pkg-config files)</li>
<li>Pre-defined and user-defined events</li>
<li>Simple macros for code instrumentation</li>
<li>Streaming events to file, through TCP/IP protocol, or handling them in custom function</li>
<li>Client for receiving event stream</li>
<li>Library for parsing event stream (so you can write your own client)</li>
</ul>
<h4 id="how-to-build-a-library">How to build a library</h4>
<pre><code class="language-bash">$ mkdir build
$ cd build
$ cmake ..
$ cmake --build .   # Instead of make
</code></pre>
<h4 id="attaching-hawktracer-for-profiling">Attaching HawkTracer for profiling</h4>
<ul>
<li>CMake-based projects
If you use CMake build system, you can use following code to attach HawkTracer library to your project:</li>
</ul>
<pre><code class="language-bash">project(your_project)

# optionally, you might define a path to HawkTracer's CMake module
# CMake the path below should be a path to a directory where HawkTracerConfig.cmake is located, e.g.:
# list(APPEND CMAKE_MODULE_PATH "/usr/local/lib/cmake/HawkTracer")

find_package(HawkTracer REQUIRED)

add_executable(your_project main.cc)

target_link_libraries(your_project HawkTracer::hawktracer)
</code></pre>
<ul>
<li>pkg-config
HawkTracer library provides pkg-config file which can be used to find required libraries and include paths. You can simply integrate it e.g. with your compilation command:</li>
</ul>
<pre><code class="language-bash">$ g++ my_project.cpp $(pkg-config --cflags --libs hawktracer)
</code></pre>
<h4 id="initialize-hawktracer-library">Initialize  HawkTracer library</h4>
<p>There are 2 functions which always have to be called in projects profiled by HawkTracer: ht_init and ht_deinit. Additionally, you need to specify an event listener. HawkTracer currently provides 2 listeners:</p>
<ul>
<li>TCP listener, which streams events over the network</li>
<li>File dump listener, which saves events to a file.</li>
</ul>
<pre><code class="language-bash">int main(int argc, char** argv)
{
  ht_init(argc, argv); // initialize library
  HT_Timeline* timeline = ht_global_timeline_get(); // timeline, where all events are posted. You can define your own timeline, or use global timeline
  HT_FileDumpListener* listener = ht_file_dump_listener_create("file_name.htdump", buffer_size, NULL); // initialize listener
  const size_t buffer_size = 4096; // size of internal listener's buffer
  ht_timeline_register_listener(timeline, ht_file_dump_listener_callback, listener); // register listener to a timeline

  // your code goes here...
  
  ht_timeline_flush(timeline); // flush all remaining events from timeline
  ht_timeline_unregister_all_listeners(timeline); // unregister listeners from timeline
  ht_file_dump_listener_destroy(listener); // deinitialize listener
  ht_deinit(); // uninitialize library

  return 0;
}
</code></pre>
<h4 id="instrumenting-source-code">Instrumenting source code</h4>
<p>The library provides a few helper macros for reporting data to a timeline:</p>
<pre><code class="language-bash">// Pushes any type of event to a timeline
HT_TIMELINE_PUSH_EVENT(TIMELINE, EVENT_TYPE, EVENT_PARAMETERS,...)

// Reports a duration of specific block of code (available only for C++ or C GNU compiler)
HT_TP_STRACEPOINT(TIMELINE, LABEL)

// The same as above, but automatically sets label to current function name
HT_TP_FUNCTION(TIMELINE)
</code></pre>
<p>There are few macros which report events to a global timeline, they're prefixed with G_:</p>
<pre><code class="language-bash">HT_TP_G_STRACEPOINT(LABEL)
HT_TP_G_FUNCTION()
</code></pre>
<h4 id="collect-the-data">Collect the data</h4>
<p>The code registers file dump listener, which saves all the events to a file file_name.htdump.
Assuming your events have been saved to file_name.htdump file, you can generate the JSON file running following command:</p>
<pre><code class="language-bash">$ hawktracer-to-json --source file_name.htdump --output output_file.json
</code></pre>
<h4 id="analyzing-the-data">Analyzing the data</h4>
<ul>
<li>First of all, install google-chrome (or chromium-brwser) in you own PC.</li>
<li>Open **chrome://tracing/ webpage after running the browser.</li>
<li>Click load button. Then, open  file output_file.json</li>
<li>You should see a callstack with timing</li>
</ul>
<p><img src="tools/profiling/hawktracer-chrome-tracing-out.png" border="0"></p>

    </div>
        




		
	</div>
	<div id="search_results">
		<p>The results of the search are</p>
	</div>
	<div id="footer">
		    

	</div>
</div>

<div id="toc-column">
	
		<div class="edit-button">
		

	</div>
		<div id="toc-wrapper">
		<nav id="toc"></nav>
	</div>
</div>
</div>
</main>


<script src="assets/js/navbar_offset_scroller.js"></script>
</body>
</html>
